---
# Tasks for testing role

- name: "Configure vagrant sandbox environment"
  hosts: localhost
  roles:
    - role: amtega.vagrant_presets
      vagrant_presets_boxes_json_query: >-
        [? starts_with(name, `centos-6`)
           || starts_with(name, `centos-7`)
           || starts_with(name, `fedora-29`)
           || starts_with(name, `fedora-30`) ]

  tags:
    - sandbox

- name: "Run idempotence test"
  hosts: localhost
  roles:
    - role: amtega.vagrant_sandbox
      vagrant_sandbox_state: started
  tags:
    - sandbox

- name: Test nscd role
  hosts: vagrant_sandbox_vms
  roles:
    - role: amtega.packages

    - role: amtega.nscd
      vars:

  tasks:
    - name: "get service facts"
      service_facts:

    - debug:
        var: ansible_facts.services
        verbosity: 1

    - assert:
        that:
          - ansible_facts.services["{{nscd_service_name}}"].state == 'running'
        success_msg: "checked service nscd OK: {{nscd_service_name}}"

    - name: "echo configuration file"
      command: "cat {{nscd_config_file}}"
      register: nscd_cat

    - debug:
        var: nscd_cat.stdout
        verbosity: 1

    - assert:
        that:
          - nscd_file is search (item.name+' '+item.value)
      vars:
        nscd_file: "{{ nscd_cat.stdout | replace ('\t',' ')}}"
      when: item.state == 'present'
      with_items:
        - "{{ nscd_config_param }}"

    - name: "disable nscd"
      include_role:
        name: amtega.nscd
      vars:
        nscd_state: absent

    - name: "get service facts"
      service_facts:

    - assert:
        that: ansible_facts.services["{{nscd_service_name}}"] is not defined

  tags:
   - idempotence

- name: Cleanup vagrant sandbox
  hosts: localhost
  roles:
    - role: amtega.vagrant_sandbox
      vagrant_sandbox_state: absent
  tags:
    - cleanup
    - sandbox
